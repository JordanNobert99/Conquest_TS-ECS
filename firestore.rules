rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Auth helpers
    function isAuthenticated() {
      return request.auth != null;
    }

    // Safe admin check (returns false if user doc doesn't exist)
    function isAdmin() {
      return isAuthenticated()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).exists()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Users collection rules
    match /users/{userId} {
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow read: if isOwner(userId) || isAdmin();
      allow update: if isAdmin()
                    || (isOwner(userId)
                        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']));
      allow delete: if isAdmin();
    }

    // Matchmaking queue: allow listing for authenticated users
    match /matchmaking_queue/{queueId} {
      // explicit list permission for queries
      allow list, get: if isAuthenticated();

      // creation only if the entry's userId matches the authenticated user
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // updates restricted to owner
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // allow owner, admin, or stale-entry cleanup (older than 30s) to delete
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin() ||
        (request.time.toMillis() - (resource.data.lastHeartbeat == null ? resource.data.timestamp : resource.data.lastHeartbeat) > 30000)
      );
    }

    // Matches: players and admins can operate; permit reading/deleting older matches for cleanup
    match /matches/{matchId} {
      allow read: if isAuthenticated() && (
        resource.data.player1.userId == request.auth.uid ||
        resource.data.player2.userId == request.auth.uid ||
        isAdmin() ||
        // allow reading older matches (cleanup visibility)
        (request.time.toMillis() - (resource.data.createdAt == null ? 0 : resource.data.createdAt) > 60000)
      );

      // creation only if the creator is one of the declared players
      allow create: if isAuthenticated() && (
        request.resource.data.player1.userId == request.auth.uid ||
        request.resource.data.player2.userId == request.auth.uid
      );

      // updates allowed for involved players or admins
      allow update: if isAuthenticated() && (
        resource.data.player1.userId == request.auth.uid ||
        resource.data.player2.userId == request.auth.uid ||
        isAdmin()
      );

      // deletion allowed for admins or old matches (older than 60s) for cleanup
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        (request.time.toMillis() - (resource.data.createdAt == null ? 0 : resource.data.createdAt) > 60000)
      );
    }

    // Per-user gameData: owner can read/write; admins can read/delete
    match /gameData/{userId} {
      allow read, write: if isOwner(userId);
      allow read: if isAdmin();
      allow delete: if isAdmin();
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}